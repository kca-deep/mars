# 데이터 전처리 분석 보고서

## 1. 데이터 소스 개요

### 1.1 소방청 산악사고 데이터 (Excel)

| 파일 | 기간 | 레코드 수 | 주요 필드 |
|------|------|-----------|-----------|
| 전국 산악사고 현황 | 2024년 | 10,134건 | 신고일시, 발생장소(시/구/동/리), 사고종별 |
| 구조활동현황 | 2020년 | 13,189건 | 신고일시, 출동일시, 발생장소, 사고원인 |

**주요 사고 유형:**
- 실족 (2,724건, 27%)
- 길잃음 (2,378건, 23%)
- 기타사고 (1,194건, 12%)
- 추락 (511건, 5%)

**상위 발생 지역:**
1. 경기도 (2,011건)
2. 서울특별시 (1,579건)
3. 강원특별자치도 (1,064건)
4. 경상북도 (1,036건)

### 1.2 외부 API 데이터

| API | 제공 정보 | 위치 표현 | 레코드 수 |
|-----|-----------|-----------|-----------|
| 전파누리 (기지국) | 통신 커버리지 | 위경도 좌표 | 100건/쿼리 |
| 산악기상정보 | 기상 데이터 | 관측소명/지역코드 | 100건/쿼리 |
| 위험지역 POI | 위험 지점 | 위경도 좌표 | 300건/쿼리 |

---

## 2. 핵심 매칭 문제

### 2.1 위치 표현 방식 불일치

```
┌─────────────────────────────────────────────────────────────┐
│  소방청 데이터          vs         API 데이터               │
├─────────────────────────────────────────────────────────────┤
│  텍스트 주소                      좌표 (lat/lon)            │
│  "강원특별자치도 횡성군           35.363388, 127.795341     │
│   강림면 강림리"                                            │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 해결 전략

| 전략 | 방법 | 장점 | 단점 |
|------|------|------|------|
| **A. 지오코딩** | 주소 → 좌표 변환 | 정확한 위치 | API 비용, 속도 제한 |
| **B. 역지오코딩** | 좌표 → 행정구역 | 빠른 일괄처리 | Shapefile 필요 |
| **C. 하이브리드** | 공간 그리드 기반 | 확장성 좋음 | 구현 복잡 |

**권장: B안 (역지오코딩 + Spatial Join)**

---

## 3. 필수 전처리 단계

### 3.1 Phase 1: 데이터 정규화

#### 소방청 데이터 전처리
```python
# 1. 행정구역명 정규화
df['발생장소_시'] = df['발생장소_시'].replace({
    '강원도': '강원특별자치도',
    '전라북도': '전북특별자치도',
    '제주도': '제주특별자치도'
})

# 2. 일시 파싱
df['신고일시'] = pd.to_datetime(
    df['신고년월일'] + ' ' + df['신고시각']
)

# 3. 시간대 추출 (수색 시간 예측용)
df['시간대'] = df['신고일시'].dt.hour
df['요일'] = df['신고일시'].dt.dayofweek
df['월'] = df['신고일시'].dt.month
```

#### API 데이터 전처리
```python
# 기지국 좌표 → GeoDataFrame
from geopandas import GeoDataFrame, points_from_xy

gdf_stations = GeoDataFrame(
    stations_df,
    geometry=points_from_xy(stations_df.LON, stations_df.LAT),
    crs="EPSG:4326"
)
```

### 3.2 Phase 2: 공간 매칭 (Spatial Join)

#### 필요 리소스
1. **행정구역 경계 Shapefile** (통계청 SGIS 제공)
   - 시도 경계: `ctprvn.shp`
   - 시군구 경계: `sig.shp`
   - 읍면동 경계: `emd.shp`

2. **국립공원 경계 Shapefile** (국립공원공단)

#### 구현 코드
```python
import geopandas as gpd

# 행정구역 경계 로드
admin_boundaries = gpd.read_file('data/shapefiles/sig.shp')
admin_boundaries = admin_boundaries.to_crs("EPSG:4326")

# API 좌표 데이터를 행정구역에 매칭
matched = gpd.sjoin(
    gdf_stations,           # 기지국 좌표
    admin_boundaries,       # 행정구역 폴리곤
    how='left',
    predicate='within'
)

# 결과: 각 기지국에 시/군/구 정보 추가됨
```

### 3.3 Phase 3: 피처 엔지니어링

#### 공간 그리드 시스템 (H3 권장)
```python
import h3

# 사고 위치를 H3 셀로 변환 (해상도 7 ≈ 5km²)
def get_h3_cell(lat, lon, resolution=7):
    return h3.geo_to_h3(lat, lon, resolution)

# 그리드별 집계
df['h3_cell'] = df.apply(
    lambda x: get_h3_cell(x['lat'], x['lon']), axis=1
)
```

#### 파생 피처
| 피처 | 설명 | 데이터 소스 |
|------|------|-------------|
| `cell_signal_strength` | 그리드 내 평균 신호 강도 | 기지국 API |
| `cell_elevation` | 그리드 평균 고도 | 기지국 SEA_ALT |
| `cell_danger_count` | 그리드 내 위험지점 수 | 위험지역 API |
| `cell_weather_risk` | 기상 위험도 | 산악기상 API |
| `cell_accident_history` | 과거 사고 건수 | 소방청 데이터 |

---

## 4. 데이터 파이프라인 설계

```
┌─────────────────────────────────────────────────────────────────┐
│                     데이터 파이프라인                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [소방청 Excel]     [기지국 API]    [기상 API]    [위험지역 API] │
│       │                 │              │              │         │
│       ▼                 ▼              ▼              ▼         │
│  ┌─────────┐      ┌──────────┐   ┌─────────┐   ┌──────────┐    │
│  │ 주소    │      │ 좌표     │   │ 관측소  │   │ 좌표     │    │
│  │ 정규화  │      │ → H3셀   │   │ → 지역  │   │ → H3셀   │    │
│  └────┬────┘      └────┬─────┘   └────┬────┘   └────┬─────┘    │
│       │                │              │              │         │
│       ▼                ▼              ▼              ▼         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Spatial Join (H3 Cell 기준)                │   │
│  └─────────────────────────┬───────────────────────────────┘   │
│                            │                                    │
│                            ▼                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              통합 피처 테이블 (학습용)                   │   │
│  │  - h3_cell (PK)                                         │   │
│  │  - 사고 이력, 기지국 정보, 기상 정보, 위험지점 정보     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 구현 우선순위

| 순서 | 작업 | 필요 리소스 | 예상 소요 |
|------|------|-------------|-----------|
| 1 | 행정구역 Shapefile 다운로드 | SGIS 계정 | 1일 |
| 2 | 소방청 데이터 정규화 | - | 0.5일 |
| 3 | 지오코딩 (주소→좌표) | Kakao/Naver API | 1일 |
| 4 | H3 그리드 시스템 구축 | h3-py 라이브러리 | 0.5일 |
| 5 | Spatial Join 파이프라인 | geopandas | 1일 |
| 6 | 피처 엔지니어링 | - | 1일 |

---

## 6. 필요 추가 데이터

1. **행정구역 경계 Shapefile**
   - 출처: 통계청 SGIS (https://sgis.kostat.go.kr)
   - 파일: 시군구(SIG), 읍면동(EMD) 경계

2. **국립공원 경계**
   - 출처: 국립공원공단 또는 환경부

3. **DEM (수치표고모델)**
   - 출처: 국토지리정보원
   - 용도: 지형 분석 (경사도, 표고)

4. **등산로 네트워크**
   - 출처: 산림청 또는 국립공원공단
   - 용도: 경로 분석
